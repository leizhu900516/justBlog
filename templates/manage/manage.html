{% extends 'base.html' %}
{% block customcss %}
    <style>
    .layui-row-chc{width: 100%}
    .manage-left{background: #fff;height: 200px;width: 20%;float: left;}
    .manage-right{background: #fff;width: 79%;float: right;}
    ul{list-style: none}
    .lay-blog .container-wrap{height: 1054px!important;}
    .chc-manage-items{padding-left: 22%;line-height: 34px;padding-top: 11px;}
    .chc-manage-items li{color: #666666;font-size: 16px; margin-top: 10px;}
    .chc-manage-items li:hover{color: #1e9fff;}
    .chc-manage-items-this{border-left: 5px solid #1e9fff;color: #1e9fff!important;padding-left: 4px!important;font-weight: bold}
    .chc-manage-submit{float: right;margin-top: 12px;margin-bottom: 10px;margin-right: 10px;}
    .layui-form-item {padding: 5px!important;}
    </style>
{% endblock %}
{% block content %}
    <div class="container-wrap">
			<div class="container">
					<div class="contar-wrap">
                        <h4 class="item-title">
							<p><i class="layui-icon layui-icon-set"></i>配置：<span>后台管理</span></p>
						</h4>
                        <div class="layui-row-chc ">
                            <div class="manage-left" >
                                <div>
                                    <ul class="chc-manage-items">
                                        <li class="chc-manage-items-this publish-article">发布文章</li>
                                        <li class="publish-broadcost">发布公告</li>
                                        <li class="article-manage">文章管理</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="manage-right" id="manage-right">
                                <div class="chc-manage-publish-article">
                                    <form class="layui-form" action="">
                                          <div class="layui-form-item">
                                            <label class="layui-form-label">
                                                <button type="button" class="layui-btn layui-btn-normal" id="uploadid" style="margin-top: 15px">上传封面</button>
                                            </label>
                                            <div class="layui-input-block">
                                                <div class="layui-upload">

                                                  <div class="layui-upload-list" style="float: right;margin-right: 20%">
                                                    <img class="layui-upload-img" id="demo1" style="height: 70px;width: 70px">
                                                    <p id="demoText"></p>
                                                  </div>
                                                </div>
                                            </div>
                                          </div>
                                          <div class="layui-form-item">
                                            <label class="layui-form-label">
                                                标题：
                                            </label>
                                            <div class="layui-input-block">
                                                <input class="layui-input" name="title"  type="text" placeholder="请输入标题">
                                            </div>
                                          </div>
                                          <div class="layui-form-item">
                                            <label class="layui-form-label">
                                                摘要：
                                            </label>
                                            <div class="layui-input-block">
                                                <textarea placeholder="请输入文章摘要" class="layui-textarea" name="abstract"></textarea>
                                            </div>
                                          </div>
                                          <div class="layui-form-item" style="padding: 5px">
                                            <textarea class="layui-textarea" id="LAY_demo1" style="display: none">
                                              请输入文章内容
                                            </textarea>
                                          </div>

                                    <button class="layui-btn layui-btn-normal chc-manage-submit" lay-submit="" lay-filter="articlesubmit">发布</button>
                                    </form>
                                </div>
                                <div class="chc-manage-publish-broadcast" style="display: none">
                                    <form class="layui-form" action="" onsubmit="return false">
                                          <div class="layui-form-item" style="color: #666666;padding: 10px;font-size: 16px;">
                                            公告内容：

                                          </div>
                                          <div class="layui-form-item">
                                            <textarea placeholder="请输入公告内容！" class="layui-textarea" name="broadcast"></textarea>
                                          </div>

                                          <button class="layui-btn layui-btn-normal chc-manage-submit" lay-submit="" lay-filter="broadcastsubmit">发布</button>
                                    </form>
                                </div>
                                <div id="article-list" style="display: none;padding-left: 5px;padding-right: 5px">
                                    <div>
                                    <table class="layui-table" lay-data="{url:'/article/list/', page:true, id:'idTest'}" lay-filter="demo">
                                      <thead>
                                        <tr>
                                          <th lay-data="{field:'id', width:'10%', sort: true, fixed: true}">ID</th>
                                          <th lay-data="{field:'title', width:'30%'}">标题</th>
                                          <th lay-data="{field:'addtimes', width:'30%', sort: true}">发布时间</th>

                                          <th lay-data="{fixed: 'right', width:'30%', align:'center', toolbar: '#barDemo'}"></th>
                                        </tr>
                                      </thead>
                                    </table>

                                    <script type="text/html" id="barDemo">
{#                                      <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看</a>#}
                                      <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
                                    </script>
                                    </div>

                                </div>

                            </div>
                        </div>

					</div>

			</div>
		</div>
{% endblock %}
{% block customjs %}
<script>
layui.use(['layedit','upload','form','layer','table'], function(){
  var layedit = layui.layedit
  ,$ = layui.jquery
  ,form = layui.form
  ,layer = layui.layer
      ,table = layui.table
  ,upload = layui.upload;
    var coverimg = "";
  //普通图片上传
  var uploadInst = upload.render({
    elem: '#uploadid'
    ,url: '/upload/'
    ,before: function(obj){
      //预读本地文件示例，不支持ie8
      obj.preview(function(index, file, result){
          console.log(index,file,result)
        $('#demo1').attr('src', result); //图片链接（base64）
          coverimg = result;
      });
    }
    ,done: function(res){
      //如果上传失败
      if(res.code > 0){
        return layer.msg('上传失败');
      }
      //上传成功
    }
    ,error: function(){
      //演示失败状态，并实现重传
      var demoText = $('#demoText');
      demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
      demoText.find('.demo-reload').on('click', function(){
        uploadInst.upload();
      });
    }
  });
  //构建一个默认的编辑器
  var index = layedit.build('LAY_demo1');

  //编辑器外部操作
  var active = {
    content: function(){
      alert(layedit.getContent(index)); //获取编辑器内容
    }
    ,text: function(){
      alert(layedit.getText(index)); //获取编辑器纯文本内容
    }
    ,selection: function(){
      alert(layedit.getSelection(index));
    }
  };

  $('.site-demo-layedit').on('click', function(){
    var type = $(this).data('type');
    active[type] ? active[type].call(this) : '';
  });

  //自定义工具栏
  layedit.build('LAY_demo2', {
    tool: ['face', 'link', 'unlink', '|', 'left', 'center', 'right']
    ,height: 100
  });
    //后台管理标签点击切换
    $(".chc-manage-items li").on("click",function () {
        var that = this;
        var li_index = $(".chc-manage-items li").index($(that));
        $(that).siblings('li').removeClass("chc-manage-items-this");
        $(that).addClass("chc-manage-items-this");
        $(".manage-right>div").siblings("div").css("display","none");
        $(".manage-right>div").eq(li_index).css("display","block");
    });
  form.on('submit(broadcastsubmit)', function(data){
      $.ajax({
          url:"/broadcast/",
          type:"post",
          data:data.field,
          dataType: "json",
          success:function (data) {
              console.log(data)
              if(data.code == 0){
                  layer.msg('修改成功');
              }
          }
      })
    return false;
  });
  form.on('submit(articlesubmit)', function(data){
      console.log(data.field)
      data.field['content'] = layedit.getContent(index);
      data.field['coverimg'] = coverimg;
      $.ajax({
          url:"/article/",
          type:"post",
          data:data.field,
          dataType: "json",
          success:function (data) {
              console.log(data)
              if(data.code == 0){
                  layer.msg('发布成功',{time:2000},function () {
                      window.location.reload();
                  });
              }
          }
      })
    return false;
  });

  //表格
  table.on('checkbox(demo)', function(obj){
    console.log(obj)
  });
  //监听工具条
  table.on('tool(demo)', function(obj){
    var data = obj.data;
    if(obj.event === 'detail'){
      layer.msg('ID：'+ data.id + ' 的查看操作');
    } else if(obj.event === 'del'){
      layer.confirm('真的删除行么', function(index){
        obj.del();
        layer.close(index);
        $.ajax({
            url:"/article/",
            type:"DELETE",
            dataType:"json",
            data:{"id":data.id},
            success:function (data) {
                if(data.code==0){
                    layer.msg("删除成功",{"time":2000},function () {
                        window.location.reload();
                    });

                }
            }
        })
      });
    } else if(obj.event === 'edit'){
      layer.alert('编辑行：<br>'+ JSON.stringify(data))
    }
  });

  var $ = layui.$, active = {
    getCheckData: function(){ //获取选中数据
      var checkStatus = table.checkStatus('idTest')
      ,data = checkStatus.data;
      layer.alert(JSON.stringify(data));
    }
    ,getCheckLength: function(){ //获取选中数目
      var checkStatus = table.checkStatus('idTest')
      ,data = checkStatus.data;
      layer.msg('选中了：'+ data.length + ' 个');
    }
    ,isAll: function(){ //验证是否全选
      var checkStatus = table.checkStatus('idTest');
      layer.msg(checkStatus.isAll ? '全选': '未全选')
    }
  };

  $('.demoTable .layui-btn').on('click', function(){
    var type = $(this).data('type');
    active[type] ? active[type].call(this) : '';
  });
});
</script>
{% endblock %}

